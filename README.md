# VentusGuard

![image](https://github.com/user-attachments/assets/0589c56a-6112-4abb-8383-b2256f9f6be3)

# Модуль А
| ФИО Участника              | Роль                           | Обязанности                                                           |
|----------------------------|--------------------------------|-----------------------------------------------------------------------|
| Задбаев Олег Валериевич    | Тим лидер, программист         | Организация работы команды. Разработка концепций проекта. Написание программ полета. Создание документации |
| Ткачук Анастасия Игоревна  | Инженер-техник, SMM специалист | Настройка и наладка оборудования. Работа с документацией. Создание медиматериалов   |
| Грядунов Артемий Павлович  | Программист, тестировщик       | Работа с технологией IoT, отладка программ с полётами                                |
| Денисов Денис Метимович    | Главный разработчик            | Разработка и написание алгоритмов проекта, тестирование. Разработка web приложения и работа с CV |

## Цель проекта: 
* Обеспечить безопасность дома или местности за счет системы VentusGuard
* Интеграции квадрокоптера/ровера в систему "Умный дом" через Яндекс станцию и Алису
* Распознавания человека с любого ракурса через технологию искусственного интеллекта (ИИ) и машинного обучения (МО)

## Основные функции:
* Активация протокола защиты через систему умного дома
* Фиксация любого движения системой датчиков
* Автоматическая активация беспилотника/ровера, вылет на точку “происшествия”
* Распознавание искусственным интеллектом фигуры человека, фиксация его действий
* Дистанционная подача сигнала владельцу о происшествии

## Принцип работы системы: 
Хозяин покидает свою квартиру, после чего активируется протокол защиты. При вторжении датчик засекает факт несанкционированного движения, активируется беспилотник для дальнейшего облёта дома и проверки. Искусственный интеллект распознает фигуру человека, фиксирует его действия. В тот же момент владельцу квартиры подается сигнал о правонарушении с трансляцией. В случае если у клиента дома имеются домашние животные или требуется меньший уровень шума-точно такая же последовательность действий реализуется на ровере

## Преимущества: 
* Дрону по сравнению с обычно камерой слежения не нужно работать 24 часа в сутки, он активируется только по факту зафиксированного движения. Обычные камеры слежения и датчики движения работают независимо друг от друга, что является непродуктивно. мы объединяем и упрощаем      
* Искусственный интеллект способен самостоятельно распознать причину срабатывания датчиков, и в случае ложной тревоги владелец квартиры не будет оповещен просто так
* Камера дрона ведет видеозапись всего происходящего вокруг и не ограничена углом обзора
* Цена системы не зависит от размера охраняемого объекта. Одна автономная станция может охватить большую площадь помещения без покупки доп камер
* Не требуется вмешательства в архитектуру помещения под системы проводов, как это происходит при установке обычных камер наблюдения

## Какую проблему решаем своим проектом: 
* Несовершенство уже имеющихся систем безопасности подвергает большому риску имущество клиента
  
## Целевая аудитория проекта: 
* Люди которые ценят свое время и деньги и максимально заботятся о безопасности своего помещения, будь то квартира, склад или частный дом. Они открыты к новому и готовы к внедрению современных технологий в свою жизнь

## Задачи
| Описание задачи                                             | Ответственный                       | Срок выполнения | Статус     | Какие технологии / инструменты / ПО применялись при решении задачи                          |
|-------------------------------------------------------------|-------------------------------------|----------------|------------|---------------------------------------------------------------------------------------------|
| Разработка и проработка концепции проекта                   | Задбаев Олег Валериевич             | 23.09.2024     | Готово     | Google поисковик                                                                           |
| Разработка и ведение документации модуля А                  | Ткачук Анастасия Игоревна           | 23.09.2024     | Готово     | Экосистема Google (документы, таблицы, диск и т.д.), GitHub                                 |
| Разработка web приложения                                   | Денисов Денис Метимович             | 23.09.2024     | Готово     | Python, JS, FastAPI, UVicorn,                                                              |
| Интеграция с технологией умного дома через Алису            | Грядунов Артемий Павлович           | 23.09.2024     | Готово     | Яндекс навыки, Яндекс диалоги, Python                                                       |
| Настройка дрона                                             | Грядунов Артемий Павлович           | 23.09.2024     | В процессе | QGroundControl, Chrome                                                                     |
| Настройка ровера и написание программы управления           | Грядунов Артемий Павлович           | 24.09.2024     | В процессе | DronesHub rover, JS, Python                                                                 |
| Разработка системы безопасности с датчиком движения         | Грядунов Артемий Павлович           | 24.09.2024     | В процессе | Python, Raspberry pi 4, лазерный дальномер                                                  |
| Разработка программы компьютерного зрения                   | Денисов Денис Метимович             | 24.09.2024     | В процессе | Python, JS, FastAPI, UVicorn, OpenCV, mediapipe                                             |
| Ведение документации модуля B                               | Ткачук Анастасия Игоревна           | 24.09.2024     | В процессе | Экосистема Google (документы, таблицы, диск и т.д.), GitHub                                 |
| Создание медиаматериалов для документации                   | Ткачук Анастасия Игоревна           | 25.09.2024     | В процессе | Камера, Canva, CapCut, Adobe Premiere                                                       |
| Ведение документации модуля C                               | Ткачук Анастасия Игоревна           | 25.09.2024     | В процессе | Экосистема Google (документы, таблицы, диск и т.д.), GitHub                                 |
| Тестирование программ в симуляторе                          | Задбаев Олег Валериевич             | 25.09.2024     | В процессе | Python, JS, VMware, Gazebo                                                                  |
| Тестирование программ на лётном полигоне                    | Грядунов Артемий Павлович           | 25.09.2024     | В процессе | Python, Chrome, Clover4                                                                     |
| Отладка финальной версии и создание финальных медиаматериалов| Ткачук Анастасия Игоревна           | 26.09.2024     | В процессе | Python, Chrome, Clover4, Камера, Canva, CapCut, Adobe Premiere                              |
| Ведение документации модуля D                               | Задбаев Олег Валериевич             | 27.09.2024     | В процессе | Экосистема Google (документы, таблицы, диск и т.д.), GitHub                                 |
| Запаковка проекта для презентации                           | Ткачук Анастасия Игоревна           | 27.09.2024     | В процессе | Камера, Canva, CapCut, Adobe Premiere                                                       |
| Запаковка проекта для презентации                           | Задбаев Олег Валериевич             | 29.09.2024     | В процессе | Clover4, DronesHub Rover, умная колонка Яндекс, Raspberry pi 4 + датчик движения.           |

# Module B

# Видео демонстрация работы проекта:

https://drive.google.com/file/d/1oQBfrHlwca7omFI9kmrP8f3Wsbes4dh1/view?usp=sharing

## Список требований к системе:

* Система безопасности должна иметь датчик движения, который активируется при выходе хозяина из квартиры
* User Friendly интерфейс
* Интеграция в умный дом для простоты реализации с различными наборами датчиков
* Дрон должен иметь легкую блочную систему построения маршрута для пользователя
* Дрон должен иметь функцию автономного распознавания человека через ИИ.
* Компьютерное зрение должно определять контур человека со спины, сбоку, в маске
* Должен быть реализован тот же функционал и через наземный беспилотник(ровер)

## Первая версия пользовательского интерфейса
![image](https://github.com/user-attachments/assets/2f69c6eb-be29-459d-931a-7f113de5e9d4)


## Алгоритм работы:

![image](https://github.com/user-attachments/assets/94597c95-00a8-401a-aed8-1e0cbd49b0be)

1. **Получение изображения с камер**:
    - Приложение подключается к двум камерам: основной камере дрона и USB-камере.
    - Изображения с камер постоянно отправляются на сервер в формате JPEG, закодированные в Base64.
    - Клиентское приложение получает эти изображения и отображает их на веб-странице.
2. **Детекция человека на изображении**:
    - На стороне сервера установлен MediaPipe - библиотека компьютерного зрения, которая обрабатывает изображения с камер в режиме реального времени.
    - Для каждого кадра MediaPipe пытается обнаружить наличие человека на изображении.
    - Если человек обнаружен, на изображении рисуется скелет человека, и это изображение отправляется клиенту для отображения.
    - Когда человек обнаружен, статус детекции на клиентской стороне меняется на "Active".
3. **Управление дроном**:
    - Клиентское приложение предоставляет пользователю интерфейс для управления дроном.
    - Пользователь может отправлять различные команды, такие как взлет, посадка, перемещение вперед/назад/влево/вправо.
    - Эти команды отправляются на сервер через WebSocket-соединение.
    - На стороне сервера команды обрабатываются и соответствующие действия выполняются с помощью ROS-сервисов, управляющих дроном.
4. **Отображение состояния дрона**:
    - Состояние дрона (уровень заряда батареи, высота, статус) постоянно отправляется с сервера на клиента через WebSocket.
    - Клиентское приложение обновляет отображение состояния дрона на веб-странице.
5. **Управление подсветки дрона**:
    - Пользователь может выбрать цвет светодиодов дрона и отправить команду на сервер.
    - Сервер обрабатывает эту команду и отправляет соответствующие данные на дрон через ROS-сервис.
6. **Сценарии полета**:
    - Пользователь может создавать и сохранять сценарии полета, состоящие из последовательности команд (взлет, перемещение, посадка).
    - Клиентское приложение предоставляет интерфейс для добавления, редактирования и запуска этих сценариев.
    - При запуске сценария клиент отправляет на сервер последовательность команд, которые выполняются дроном.

![image](https://github.com/user-attachments/assets/2f64a398-ee7f-45c4-b877-a2be002c591d)

Весь этот функционал реализован с использованием следующих технологий:

- На серверной стороне: FastAPI (Python веб-фреймворк), ROS (Robot Operating System), OpenCV, MediaPipe.
- На клиентской стороне: HTML, CSS, JavaScript, WebSocket.

Ниже представлены фрагменты кода, иллюстрирующие ключевые части описанного алгоритма:

**Получение изображения с камер и отправка на клиент**
```python
@app.websocket("/ws/drone")
async def drone_websocket(websocket: WebSocket):
    # ...
    while True:
        data = await websocket.receive_text()
        data = json.loads(data)
        if data.get("type") == "camera":
            image_data = base64.b64decode(data["data"])
            nparr = np.frombuffer(image_data, np.uint8)
            image = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
            
            processed_image, human_detected = process_image(image)
            
            if human_detected:
                save_detection(processed_image)
            
            await broadcast_image(processed_image, data["name"])
```
**Детекция человека на изображении**
```python
def process_image(image):
    image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    results = pose.process(image_rgb)
    
    if results.pose_landmarks:
        mp_drawing.draw_landmarks(image, results.pose_landmarks, mp_pose.POSE_CONNECTIONS)
        return image, True
    
    return image, False
```
**Отправка команд на дрон**
```python
async def process_command(command):
    global drone_ws
    if drone_ws:
        await drone_ws.send_text(json.dumps(command))
        try:
            response = await asyncio.wait_for(drone_ws.receive_text(), timeout=1.0)
            response_data = json.loads(response)
            for client in clients:
                await client.send_text(json.dumps({
                    "type": "command_result",
                    "command": command["command"],
                    "success": response_data.get("success", False),
                    "error": response_data.get("error")
                }))
        except asyncio.TimeoutError:
            # Handle timeout error
        except Exception as e:
            # Handle other exceptions
```
**Отображение состояния дрона**
```python
function updateDroneState(state) {
    document.getElementById('battery').textContent = state.battery.toFixed(2);
    document.getElementById('altitude').textContent = state.altitude.toFixed(2);
    document.getElementById('gps').textContent = `${state.gps.lat.toFixed(6)}, ${state.gps.lon.toFixed(6)}`;
    document.getElementById('status').textContent = state.status;
}
```
7. **Пользовательский интерфейс**:
    - Клиентское приложение использует HTML, CSS и JavaScript для построения пользовательского интерфейса.
    - Интерфейс разделен на вкладки: "Main", "Scenarios" и "Debug".
    - На вкладке "Main" отображаются видеопотоки с камер дрона, состояние дрона, а также элементы управления для взлета, посадки и перемещения.
    - На вкладке "Scenarios" пользователь может создавать и запускать сценарии полета.
    - На вкладке "Debug" находится консоль для отображения отладочной информации и ввода команд для отправки на сервер.
8. **Взаимодействие через WebSocket**:
    - Клиентское и серверное приложения общаются через WebSocket-соединение.
    - Клиент отправляет команды на сервер, а сервер отправляет обновления состояния дрона и видеопотоки обратно клиенту.
    - На стороне клиента обрабатываются сообщения, получаемые через WebSocket, и производится обновление пользовательского интерфейса.
9. **Сценарии полета**:
    - На клиентской стороне пользователь может создавать и редактировать сценарии полета.
    - Сценарий состоит из последовательности команд, таких как взлет, перемещение и посадка.
    - При нажатии на кнопку "Run Scenario" клиент отправляет на сервер последовательность команд, которые выполняются дроном.
    - Во время выполнения сценария пользовательский интерфейс блокируется, чтобы предотвратить возможность случайного вмешательства.
10. **Отладка и журналирование**:
    - На вкладке "Debug" находится консоль, которая отображает все сообщения, отправляемые между клиентом и сервером.
    - Пользователь может также отправлять произвольные команды в формате JSON, которые будут переданы на сервер.
    - Серверная часть приложения ведет журнал ошибок и предупреждений, чтобы облегчить процесс отладки.

Ниже приведены дополнительные примеры кода, демонстрирующие реализацию некоторых из этих особенностей:

**Обработка сценариев полета на клиентской стороне**
```javascript
async function runScenario() {
    // ...
    const blocks = Array.from(scenarioBlocks.children);
    for (let block of blocks) {
        const [action, value] = block.textContent.split(':');
        try {
            if (action.startsWith('Takeoff')) {
                await sendCommand({command: 'takeoff', height: parseFloat(value)});
            } else if (action.startsWith('Move')) {
                // ...
            } else if (action === 'Land') {
                await sendCommand({command: 'land'});
            }
            await new Promise(resolve => setTimeout(resolve, 5000));
        } catch (error) {
            console.error('Error executing command:', error);
            addDebugMessage(`Error executing command: ${error.message}`);
            break;
        }
    }
    // ...
}
```
**Обработка произвольных команд на клиентской стороне**
```javascript
sendCommandBtn.addEventListener('click', () => {
    const command = commandInput.value;
    if (command) {
        try {
            const commandObj = JSON.parse(command);
            sendCommand(commandObj);
            commandInput.value = '';
        } catch (error) {
            addDebugMessage(`Error: Invalid JSON - ${error.message}`);
        }
    }
});
```
Таким образом, это приложение предоставляет расширенные возможности для управления и мониторинга беспилотного летательного аппарата, включая визуальную обратную связь, автоматизацию полетов и средства для отладки и журналирования.

# **VentusGuard Drone & Rover Control - Полная Документация**

## **1. О проекте**

VentusGuard Drone & Rover Control — это многофункциональное веб-приложение, разработанное для удаленного управления дроном и ровером с использованием современного стек технологий, таких как FastAPI, WebSocket, ROS1 и Clover. Этот проект ориентирован на решение задач, связанных с автоматизированным управлением беспилотниками и наземными роботами, предоставляя пользователю возможность создавать сценарии для автономных миссий, управлять устройствами вручную и отслеживать их состояние в реальном времени.

### **1.1. Основные функции**
- **Управление дроном и ровером**: Взлет и посадка дрона, передвижение ровера, управление светодиодами, настройка высоты и скорости.
- **Просмотр видеопотоков**: Прямой видеопоток с камеры дрона и USB камеры для мониторинга обстановки.
- **Автономные сценарии**: Пользователи могут создавать сложные сценарии, задавая последовательность действий для дрона и ровера, и выполнять их автоматически.
- **Двусторонняя связь с устройствами**: Использование WebSocket для передачи команд и получения информации от дрона и ровера без задержек.
- **Интерактивный интерфейс**: Веб-интерфейс позволяет пользователю управлять устройствами через кнопки, предоставляя удобный способ контроля.

### **1.2. Интересные задачи, решенные в проекте**
- **Реализация управления реального времени**: Использование WebSocket для непрерывной передачи данных между клиентом и сервером позволяет пользователю управлять дронами и роверами без задержек.
- **Интеграция с ROS**: Система использует ROS (Robot Operating System) для управления Clover дроном, что упрощает взаимодействие с реальными роботами и дронами в полевых условиях.
- **Автоматизация полетов и перемещений**: Возможность заранее задавать маршруты и действия для дронов и роботов открывает возможности для использования в спасательных операциях, наблюдении и других задачах.

## **2. Технологии**

### **2.1 FastAPI**
FastAPI — это современный, быстрый (high-performance), веб-фреймворк для создания API на Python 3.6+ на основе стандартов Python type hints. В проекте VentusGuard он используется для создания RESTful API и WebSocket-сервера, который обрабатывает запросы от клиента и отправляет команды на дрон и ровер.

**Основные преимущества FastAPI**:
- **Высокая скорость работы**: В основе FastAPI лежит библиотека Starlette, которая делает сервер быстрым и отзывчивым, что критично для управления устройствами в реальном времени.
- **Поддержка WebSocket**: FastAPI поддерживает WebSocket «из коробки», что позволяет легко организовать двустороннюю передачу данных между клиентом и сервером.
- **Простота разработки**: FastAPI использует аннотации типов, что упрощает процесс разработки и повышает читаемость кода.

```python
from fastapi import FastAPI, WebSocket

app = FastAPI()

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    while True:
        data = await websocket.receive_text()
        await websocket.send_text(f"Received: {data}")
```
В приведённом коде реализован сервер WebSocket, который принимает сообщения от клиента и отправляет обратно подтверждение. Эта структура используется для обработки команд управления дронами и роверами.

### **2.2 WebSocket**
WebSocket — это протокол связи, который обеспечивает постоянное двустороннее соединение между клиентом и сервером. В проекте WebSocket используется для передачи данных реального времени между веб-клиентом и сервером FastAPI, что позволяет управлять дроном и ровером мгновенно, а также получать актуальные данные от устройств, такие как видеопотоки и состояние батареи.

**Преимущества WebSocket**:
- **Поддержка реального времени**: WebSocket идеально подходит для приложений, которые требуют мгновенной реакции, таких как управление беспилотниками и передача видеопотоков.
- **Эффективное использование ресурсов**: В отличие от HTTP, который использует запросы и ответы, WebSocket поддерживает постоянное соединение, что снижает задержки и потребление ресурсов.

### **2.3 ROS (Robot Operating System)**
ROS — это набор фреймворков и инструментов для разработки программного обеспечения для роботов. В данном проекте ROS1 используется для управления дроном через Clover, предоставляя возможность взаимодействия с реальными устройствами.

**Основные компоненты ROS**:
- **Ноды**: Ноды — это программы, которые взаимодействуют друг с другом, передавая сообщения. В проекте каждая нода отвечает за определённую задачу, такую как управление движением дрона или получение данных с сенсоров.
- **Топики**: Топики используются для обмена данными между нодами. Например, камера дрона передает данные через топик, который может быть прочитан другими нодами.
- **Службы (Services)**: Службы в ROS позволяют нодам выполнять синхронные вызовы. В данном проекте это используется для таких команд, как взлет и посадка.

Пример вызова службы для взлета дрона:
```python
import rospy
from clover import srv

rospy.init_node('drone_controller')
takeoff_srv = rospy.ServiceProxy('takeoff', srv.Takeoff)
takeoff_srv(height=1.5)
```

### **2.4 Clover**
Clover — это программная платформа для дронов на базе ROS, которая упрощает создание автономных систем. Clover поддерживает такие функции, как автоматизированное управление дроном, работа с камерой, интеграция с ROS и многое другое. В проекте Clover используется для работы с дроном, предоставляя возможности по управлению полетом и съемке.

---

## **3. Структура проекта**

Проект VentusGuard состоит из нескольких ключевых файлов и директорий, каждая из которых отвечает за свою часть функциональности.

- **static/**: Эта директория содержит статические файлы проекта, такие как CSS стили и JavaScript файлы, которые используются для отображения интерфейса и реализации клиентской логики.
  - **css/style.css**: Файл со стилями для пользовательского интерфейса.
  - **js/app.js**: Основной JavaScript файл, который управляет взаимодействием с сервером через WebSocket и обновлением интерфейса.
  
- **templates/**: Директория для HTML шаблонов, использующихся FastAPI для отображения веб-страниц.
  - **index.html**: Главный шаблон страницы, который включает все элементы управления дроном и ровером.

- **drone.py**: Python файл, отвечающий за управление дроном с использованием ROS. В этом файле вызываются сервисы ROS для выполнения действий, таких как взлет, посадка и изменение положения дрона.

- **rover.py**: Файл, отвечающий за управление ровером, включая функции передвижения и манипуляции светодиодами.

- **main.py**: Основной серверный файл FastAPI, который отвечает за обработку запросов от клиента, создание WebSocket соединений и маршрутизацию страниц.

---

## **4. Объяснение кода**

### **4.1 main.py**

Файл `main.py` отвечает за настройку и запуск FastAPI сервера, обработку запросов и реализацию WebSocket соединений.

Пример:
```python
from fastapi import FastAPI, WebSocket, Request
from fastapi.templating import Jinja2Templates

app = FastAPI()
templates = Jinja2Templates(directory="templates")

@app.get("/")
async def get(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})
```

Эта часть кода настраивает сервер для отображения главной страницы по URL `/`. Когда пользователь заходит на сайт, сервер возвращает шаблон `index.html`.

### **4.2 WebSocket обработчик**

Для обеспечения управления дроном в реальном времени, используется WebSocket:
```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    while True:
        data = await websocket.receive_text()
        await websocket.send_text(f"Received: {data}")
```

Этот код принимает данные от клиента и отправляет обратно подтверждение. В реальном приложении через WebSocket передаются команды на управление дроном и ровером, а также видеопоток и данные с устройств.

### **4.3 Управление дроном через ROS**

Файл `drone.py` взаимодействует с ROS, чтобы управлять дроном. Например, взлет на заданную высоту:
```python
import rospy
from clover import srv

rospy.init_node('drone_controller')
takeoff_srv = rospy.ServiceProxy('takeoff', srv.Takeoff)

def takeoff(height):
    takeoff_srv(height=height)
```

Эта функция

 вызывает сервис взлета дрона, передавая высоту в качестве параметра.

---

## **5. Использование WebSocket для управления в реальном времени**

Основной причиной выбора WebSocket для управления дронами и роверами является необходимость постоянного двустороннего соединения между клиентом и сервером, что позволяет минимизировать задержки при отправке команд и получении данных.

---

## **Заключение**

Проект VentusGuard демонстрирует, как можно эффективно использовать современный стек технологий для управления автономными системами, такими как дроны и роботы. FastAPI обеспечивает высокопроизводительный сервер, WebSocket предоставляет низколатентную связь в реальном времени, а интеграция с ROS и Clover позволяет взаимодействовать с реальными устройствами.